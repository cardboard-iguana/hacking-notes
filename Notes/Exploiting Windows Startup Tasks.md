# Exploiting Windows Startup Tasks
## Startup Folder
Individual startup folders are located at `C:\Users\$USERNAME\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup` .

The shared startup folder is at `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup`; any shortcut placed here will spawn an application on *any* (normal) user login.

(The “contents” of a user’s Startup folder is the union of these two folders. If memory serves, the user folder will override the system folder for items with *exactly* the same name. Note that executables can be dropped into this folder in addition to shortcuts, though doing so may make it more difficult to hide a backdoor...)

## Run/RunOnce
Startup programs can also be configured in the registry:

* `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`
* `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce` 
	
`HKCU` applies to the current user, while `HLKM` applies to everyone.

Entries under `Run` will run every time the user logs on, while those under `RunOnce` will only be executed a single time.

Create a `REG_EXPAND_SZ` registry entry under the appropriate key that points to the appropriate payload.

## WinLogon
WinLogin is a Windows component that loads a user profile right after authentication (amongst other things). The WinLogin initialization sequence is defined in the `HKLM\Software\Microsoft\Windows NT\CurrentVersion\WinLogon\` registry key. This will contain two values:

* `Userinit`, which points to `userinit.exe`, and
* `shell` which usually points to `explorer.exe`.

**Do not replace these files!** Instead, follow the initial command with your payload, separating the two with a comma:

```
C:\Windows\System32\userinit.exe,C:\Windows\System32\evil.exe
```

## Logon Scripts
The `userinit.exe` binary checks for an environment variable called `UserInitMprLogonScript`. This variable isn’t set by default, but if defined then `userinit.exe` will run any script it specifies.

Unfortunately, there’s no way to set this globally — you have to do it one user at a time in the `HKCU\Environment` registry key. Just create a new Expandable String Value entry called `UserInitMprLogonScript` in this key that points to the location of your payload.

## Additional Resources
* [TryHackMe: Windows Local Persistence](https://tryhackme.com/room/windowslocalpersistence) 
